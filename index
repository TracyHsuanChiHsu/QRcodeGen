<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 向量產生器 Pro</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QRCode Generator Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
        }
        .preview-pattern {
            background-image: linear-gradient(45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(-45deg, #e5e7eb 25%, transparent 25%), 
                              linear-gradient(45deg, transparent 75%, #e5e7eb 75%), 
                              linear-gradient(-45deg, transparent 75%, #e5e7eb 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-10 px-4">

    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fa-solid fa-qrcode text-blue-600 mr-2"></i>QR Code 向量產生器
        </h1>
        <p class="text-gray-600">專為設計師打造，支援 EPS / SVG / PNG 輸出</p>
    </header>

    <main class="w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-hidden flex flex-col lg:flex-row">
        
        <!-- Controls Section -->
        <div class="w-full lg:w-1/2 p-8 border-r border-gray-100 space-y-6">
            
            <!-- Input Text -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">內容 (網址或文字)</label>
                <textarea id="qr-text" rows="3" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition"
                    placeholder="請輸入網址或文字...">https://www.google.com</textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <!-- Size Control -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">輸出尺寸 (px)</label>
                    <input type="number" id="qr-size" value="128" 
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <!-- Padding Control -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">白邊寬度 (px)</label>
                    <input type="number" id="qr-padding" value="5" 
                        class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
            </div>

            <!-- Colors -->
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">前景顏色</label>
                    <div class="flex items-center space-x-2">
                        <input type="color" id="qr-fg-color" value="#000000" class="h-10 w-full cursor-pointer rounded border border-gray-300">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">背景顏色</label>
                    <div class="flex items-center space-x-2">
                        <input type="color" id="qr-bg-color" value="#ffffff" class="h-10 w-full cursor-pointer rounded border border-gray-300">
                    </div>
                </div>
            </div>

            <!-- Error Correction Level -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">容錯率</label>
                <select id="qr-error-level" class="w-full p-2 border border-gray-300 rounded-lg bg-white">
                    <option value="L">L (7%)</option>
                    <option value="M" selected>M (15%) - 推薦</option>
                    <option value="Q">Q (25%)</option>
                    <option value="H">H (30%)</option>
                </select>
            </div>

            <div class="pt-4 border-t border-gray-100">
                <p class="text-xs text-gray-500 mb-3">下載選項</p>
                <div class="grid grid-cols-1 gap-3">
                    <button onclick="downloadPNG()" class="flex items-center justify-center w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition font-medium shadow-sm">
                        <i class="fa-solid fa-image mr-2"></i> 下載 PNG (點陣圖)
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="downloadSVG()" class="flex items-center justify-center w-full py-2.5 bg-gray-800 hover:bg-gray-900 text-white rounded-lg transition font-medium shadow-sm">
                            <i class="fa-solid fa-bezier-curve mr-2"></i> 下載 SVG
                        </button>
                        <button onclick="downloadEPS()" class="flex items-center justify-center w-full py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition font-medium shadow-sm">
                            <i class="fa-solid fa-file-pen mr-2"></i> 下載 EPS (AI)
                        </button>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">* EPS 檔案可使用 Adobe Illustrator 開啟</p>
            </div>
        </div>

        <!-- Preview Section -->
        <div class="w-full lg:w-1/2 bg-gray-50 flex flex-col items-center justify-center p-8 relative preview-pattern">
            <div class="absolute top-4 right-4 bg-white px-3 py-1 rounded-full text-xs font-mono text-gray-500 shadow-sm border border-gray-200">
                預覽模式
            </div>
            
            <div id="preview-container" class="shadow-2xl transition-all duration-300">
                <!-- SVG will be injected here -->
            </div>

            <div class="mt-6 text-center">
                <p id="preview-dims" class="text-sm font-mono text-gray-600">128 x 128 px</p>
                <p class="text-xs text-gray-400 mt-1">含 5px 白邊</p>
            </div>
        </div>
    </main>

    <!-- Hidden Canvas for PNG Generation -->
    <canvas id="hidden-canvas" style="display: none;"></canvas>

    <script>
        // DOM Elements
        const elText = document.getElementById('qr-text');
        const elSize = document.getElementById('qr-size');
        const elPadding = document.getElementById('qr-padding');
        const elFgColor = document.getElementById('qr-fg-color');
        const elBgColor = document.getElementById('qr-bg-color');
        const elErrorLevel = document.getElementById('qr-error-level');
        const elPreview = document.getElementById('preview-container');
        const elDims = document.getElementById('preview-dims');

        // State
        let qrData = null; // Store the QR object

        // Event Listeners
        const inputs = [elText, elSize, elPadding, elFgColor, elBgColor, elErrorLevel];
        inputs.forEach(input => {
            input.addEventListener('input', generateQR);
        });

        // Initialize
        generateQR();

        function generateQR() {
            const text = elText.value;
            const typeNumber = 0; // Auto detection
            const errorCorrectionLevel = elErrorLevel.value;
            
            try {
                qrData = qrcode(typeNumber, errorCorrectionLevel);
                qrData.addData(text || " "); // Default space if empty to prevent error
                qrData.make();
                
                renderPreview();
            } catch (e) {
                console.error("QR Code Generation Error:", e);
                if (text.length > 1000) {
                    alert("文字內容過長，請減少文字或降低容錯率。");
                }
            }
        }

        function renderPreview() {
            const size = parseInt(elSize.value) || 128;
            const padding = parseInt(elPadding.value) || 0;
            const fgColor = elFgColor.value;
            const bgColor = elBgColor.value;

            // Generate SVG String
            const svgString = createSVG(qrData, size, padding, fgColor, bgColor);
            
            // Update DOM
            elPreview.innerHTML = svgString;
            elDims.textContent = `${size} x ${size} px`;
        }

        /**
         * Creates an SVG string representing the QR code
         */
        function createSVG(qr, targetSize, padding, fg, bg) {
            const count = qr.getModuleCount();
            
            // Calculate scale
            // The QR itself (modules) needs to fit into (targetSize - 2*padding)
            const availableSize = targetSize - (padding * 2);
            const moduleSize = availableSize / count;

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${targetSize}" height="${targetSize}" viewBox="0 0 ${targetSize} ${targetSize}">`;
            
            // Draw Background
            svg += `<rect x="0" y="0" width="${targetSize}" height="${targetSize}" fill="${bg}" />`;
            
            // Draw Modules
            for (let r = 0; r < count; r++) {
                for (let c = 0; c < count; c++) {
                    if (qr.isDark(r, c)) {
                        const x = padding + (c * moduleSize);
                        const y = padding + (r * moduleSize);
                        // Using toFixed to avoid excessive decimals, ensures cleaner vector files
                        svg += `<rect x="${x.toFixed(3)}" y="${y.toFixed(3)}" width="${(moduleSize + 0.05).toFixed(3)}" height="${(moduleSize + 0.05).toFixed(3)}" fill="${fg}" />`;
                        // Note: Added 0.05 to width/height to prevent "stitching lines" (gap rendering artifacts) in some viewers
                    }
                }
            }
            
            svg += `</svg>`;
            return svg;
        }

        /**
         * Creates EPS Content string
         */
        function createEPS(qr, targetSize, padding, fgHex, bgHex) {
            const count = qr.getModuleCount();
            const availableSize = targetSize - (padding * 2);
            const moduleSize = availableSize / count;

            // Convert Hex to RGB (0-1 range for PostScript)
            const hexToRgb = (hex) => {
                const r = parseInt(hex.slice(1, 3), 16) / 255;
                const g = parseInt(hex.slice(3, 5), 16) / 255;
                const b = parseInt(hex.slice(5, 7), 16) / 255;
                return `${r.toFixed(3)} ${g.toFixed(3)} ${b.toFixed(3)}`;
            };

            const fgRGB = hexToRgb(fgHex);
            const bgRGB = hexToRgb(bgHex);

            // EPS Header
            let eps = `%!PS-Adobe-3.0 EPSF-3.0\n`;
            eps += `%%BoundingBox: 0 0 ${targetSize} ${targetSize}\n`;
            eps += `%%Pages: 1\n`;
            eps += `%%Title: QRCode\n`;
            eps += `%%Creator: QR Code Vector Tool\n`;
            eps += `%%EndComments\n`;

            // Draw Background
            eps += `${bgRGB} setrgbcolor\n`;
            eps += `0 0 ${targetSize} ${targetSize} rectfill\n`;

            // Draw Modules
            eps += `${fgRGB} setrgbcolor\n`;
            
            for (let r = 0; r < count; r++) {
                for (let c = 0; c < count; c++) {
                    if (qr.isDark(r, c)) {
                        // EPS Coordinate system starts at bottom-left
                        // We need to flip the Y axis logic
                        const x = padding + (c * moduleSize);
                        const y = targetSize - padding - ((r + 1) * moduleSize);
                        
                        eps += `${x.toFixed(3)} ${y.toFixed(3)} ${moduleSize.toFixed(3)} ${moduleSize.toFixed(3)} rectfill\n`;
                    }
                }
            }
            
            eps += `%%EOF`;
            return eps;
        }

        // --- Download Functions ---

        function downloadString(content, mimeType, filename) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadSVG() {
            const size = parseInt(elSize.value);
            const padding = parseInt(elPadding.value);
            const fg = elFgColor.value;
            const bg = elBgColor.value;
            const svgContent = createSVG(qrData, size, padding, fg, bg);
            downloadString(svgContent, 'image/svg+xml', 'qrcode.svg');
        }

        function downloadEPS() {
            const size = parseInt(elSize.value);
            const padding = parseInt(elPadding.value);
            const fg = elFgColor.value;
            const bg = elBgColor.value;
            const epsContent = createEPS(qrData, size, padding, fg, bg);
            downloadString(epsContent, 'application/postscript', 'qrcode.eps');
        }

        function downloadPNG() {
            const size = parseInt(elSize.value);
            const padding = parseInt(elPadding.value);
            const fg = elFgColor.value;
            const bg = elBgColor.value;
            const svgContent = createSVG(qrData, size, padding, fg, bg);

            const canvas = document.getElementById('hidden-canvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size (Consider 2x scale for higher dpi on screens, but user requested exact px)
            // Sticking to requested px for 1:1 mapping
            canvas.width = size;
            canvas.height = size;

            const img = new Image();
            // Convert SVG to Base64 for Image source
            const svgBlob = new Blob([svgContent], {type: 'image/svg+xml;charset=utf-8'});
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                ctx.clearRect(0, 0, size, size);
                ctx.drawImage(img, 0, 0);
                
                const pngUrl = canvas.toDataURL("image/png");
                const a = document.createElement('a');
                a.href = pngUrl;
                a.download = 'qrcode.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            img.src = url;
        }
    </script>
</body>
</html>
